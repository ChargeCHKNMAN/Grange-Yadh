<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Timetable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 10px;
        }
        table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 95%;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
        }
        th {
            background: #eee;
        }
        .not-found {
            color: red;
            margin-top: 15px;
            font-weight: bold;
        }
        .input-group {
            margin-top: 15px;
        }
        tfoot td {
            font-weight: bold;
            background: #f0f8ff;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>Student Timetable</h1>

    <!-- Student ID Input Form -->
    <form method="GET" action="/" class="input-group">
        <label for="student_id_input">Enter Student ID:</label>
        <input 
            type="text" 
            id="student_id_input" 
            name="student_id" 
            value="{{ selected_student }}" 
            placeholder="Enter student ID here" 
            required
            autocomplete="off"
        />
        <button type="submit">Submit</button>
    </form>

    <!-- Timetable Table -->
    {% if not_found %}
        <div class="not-found">Student ID "{{ selected_student }}" not found.</div>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th>Day / Time</th>
                    {% for time in time_slots %}
                        <th>{{ time }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for day, subjects in timetable %}
                    <tr>
                        <td>{{ day }}</td>
                        {% for subject in subjects %}
                            <td>{{ subject }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="{{ time_slots|length + 1 }}" id="nextClassCountdownCell">
                        Calculating time to next class...
                    </td>
                </tr>
            </tfoot>
        </table>
    {% endif %}

    <!-- Audio alert -->
    <audio id="alertSound" preload="auto">
        <source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Pass Python variables to JS via Jinja
        const timetable = {{ timetable | tojson }};
        const timeSlots = {{ time_slots | tojson }};
        const days = {{ days | tojson }};

        document.addEventListener("DOMContentLoaded", () => {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission !== "granted") {
                        alert("Enable notifications to receive class reminders.");
                    }
                });
            }

            scheduleClassReminders();
            updateNextClassCountdown();
            setInterval(updateNextClassCountdown, 60 * 1000); // update every minute
        });

        function scheduleClassReminders() {
            const now = new Date();
            const currentDayIndex = now.getDay() - 1; // Monday = 0

            if (currentDayIndex < 0 || currentDayIndex >= 5) return;

            const todaySchedule = timetable[currentDayIndex];

            timeSlots.forEach((slotTime, index) => {
                const [startHour, startMinute] = slotTime.split(" - ")[0].split(":").map(Number);
                const classTime = new Date();
                classTime.setHours(startHour, startMinute, 0, 0);

                if (classTime < now) return;

                const timeout = classTime - now;
                const subject = todaySchedule[index] || "Class";

                setTimeout(() => {
                    triggerReminder(subject, slotTime);
                }, timeout);
            });
        }

        function triggerReminder(subject, time) {
            // Visual popup
            const reminderDiv = document.createElement("div");
            reminderDiv.textContent = `⏰ Reminder: "${subject}" is starting now (${time})!`;
            reminderDiv.style.position = "fixed";
            reminderDiv.style.top = "20px";
            reminderDiv.style.left = "50%";
            reminderDiv.style.transform = "translateX(-50%)";
            reminderDiv.style.background = "#fffa65";
            reminderDiv.style.padding = "10px 20px";
            reminderDiv.style.border = "2px solid #333";
            reminderDiv.style.zIndex = "1000";
            reminderDiv.style.fontWeight = "bold";
            document.body.appendChild(reminderDiv);

            setTimeout(() => reminderDiv.remove(), 10000);

            // Audio alert
            const audio = document.getElementById("alertSound");
            if (audio) {
                audio.play().catch(e => {
                    console.warn("Audio failed to play:", e);
                });
            }

            // Browser notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("⏰ Class Reminder", {
                    body: `"${subject}" is starting now (${time})!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/565/565340.png"
                });
            }
        }

        function updateNextClassCountdown() {
            const now = new Date();
            const currentDayIndex = now.getDay() - 1; // Monday=0

            const countdownCell = document.getElementById("nextClassCountdownCell");
            if (!countdownCell) return;

            if (currentDayIndex < 0 || currentDayIndex >= 5) {
                countdownCell.textContent = "No classes today.";
                return;
            }

            const todaySchedule = timetable[currentDayIndex];

            let nextClassIndex = -1;
            let minDiff = Infinity;

            timeSlots.forEach((slotTime, index) => {
                const [startHour, startMinute] = slotTime.split(" - ")[0].split(":").map(Number);
                const classTime = new Date();
                classTime.setHours(startHour, startMinute, 0, 0);

                const diff = classTime - now;

                if (diff > 0 && diff < minDiff) {
                    minDiff = diff;
                    nextClassIndex = index;
                }
            });

            if (nextClassIndex === -1) {
                countdownCell.textContent = "No more classes today.";
                return;
            }

            const nextClassName = todaySchedule[nextClassIndex];
            const diffMinutes = Math.floor(minDiff / 60000);
            const diffSeconds = Math.floor((minDiff % 60000) / 1000);

            countdownCell.textContent = `Next class: "${nextClassName}" starts in ${diffMinutes} min ${diffSeconds} sec.`;
        }
    </script>
</body>
</html>
