<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Student Timetable</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 10px;
        }
        table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 95%;
        }
        th, td {
            border: 1px solid #333;
            padding: 8px;
        }
        th {
            background: #eee;
        }
        .not-found {
            color: red;
            margin-top: 15px;
            font-weight: bold;
        }
        .input-group {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <h1>Student Timetable</h1>

    <!-- Student ID Dropdown Form -->
    <form method="GET" action="/" class="input-group">
        <label for="student_id_input">Select Student ID:</label>
        <select id="student_id_input" name="student_id" required>
            {% for student_id in student_ids %}
                <option value="{{ student_id }}" {% if student_id == selected_student %}selected{% endif %}>
                    {{ student_id }}
                </option>
            {% endfor %}
        </select>
        <button type="submit">Submit</button>
    </form>

    <!-- Timetable Table -->
    {% if not_found %}
        <div class="not-found">Student ID "{{ selected_student }}" not found.</div>
    {% else %}
        <table>
            <tr>
                <th>Day / Time</th>
                {% for time in time_slots %}
                    <th>{{ time }}</th>
                {% endfor %}
            </tr>
            {% for day, subjects in timetable %}
                <tr>
                    <td>{{ day }}</td>
                    {% for subject in subjects %}
                        <td>{{ subject }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
    {% endif %}

    <!-- üîä Audio alert -->
    <audio id="alertSound" preload="auto">
        <source src="https://www.soundjay.com/buttons/sounds/beep-07.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Data from Flask
        const timetable = {{ timetable | tojson }};
        const timeSlots = {{ time_slots | tojson }};
        const days = {{ days | tojson }};

        document.addEventListener("DOMContentLoaded", () => {
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission().then(permission => {
                    if (permission !== "granted") {
                        alert("Enable notifications to receive class reminders.");
                    }
                });
            }

            scheduleClassReminders();
        });

        function scheduleClassReminders() {
            const now = new Date();
            const currentDayIndex = now.getDay() - 1; // Monday = 0

            if (currentDayIndex < 0 || currentDayIndex >= 5) return;

            const todaySchedule = timetable[currentDayIndex];

            timeSlots.forEach((slotTime, index) => {
                const [startHour, startMinute] = slotTime.split(" - ")[0].split(":").map(Number);
                const classTime = new Date();
                classTime.setHours(startHour, startMinute, 0, 0);

                if (classTime < now) return;

                const timeout = classTime - now;
                const subject = todaySchedule[index] || "Class";

                setTimeout(() => {
                    triggerReminder(subject, slotTime);
                }, timeout);
            });
        }

        function triggerReminder(subject, time) {
            // Visual popup
            const reminderDiv = document.createElement("div");
            reminderDiv.textContent = `‚è∞ Reminder: "${subject}" is starting now (${time})!`;
            reminderDiv.style.position = "fixed";
            reminderDiv.style.top = "20px";
            reminderDiv.style.left = "50%";
            reminderDiv.style.transform = "translateX(-50%)";
            reminderDiv.style.background = "#fffa65";
            reminderDiv.style.padding = "10px 20px";
            reminderDiv.style.border = "2px solid #333";
            reminderDiv.style.zIndex = "1000";
            reminderDiv.style.fontWeight = "bold";
            document.body.appendChild(reminderDiv);

            setTimeout(() => reminderDiv.remove(), 10000);

            // Audio alert
            const audio = document.getElementById("alertSound");
            if (audio) {
                audio.play().catch(e => {
                    console.warn("Audio failed to play:", e);
                });
            }

            // Browser notification
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification("‚è∞ Class Reminder", {
                    body: `"${subject}" is starting now (${time})!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/565/565340.png"
                });
            }
        }
    </script>
</body>
</html>
